#!/bin/ksh
#
#
# This program is the confidential and proprietary product of 
# Fast Track Systems, Inc.  Any unauthorized use, reproduction, 
# or transfer of this program is strictly prohibited.  
# Copyright (C) 2000 by Fast Track Systems, Inc.  
# All rights reserved.
# 
# $Workfile: report4Lori_5.ksh$ 
#
# $Revision: 3$        $Date: 3/15/2005 6:16:42 PM$
#
#
# Description:  <ADD>
#
#############################################################

cd /export/home/oracle
. /etc/profile
. ./.profile

mailinglist="TrialPlanningSupport@mdsol.com"
#mailinglist="dmishra@fast-track.com"
cclist="dmishra@mdsol.com"
sender="noreply@mdsol.com"
 
export ORACLE_SID=prod
sqlplus -s tsm10/`get_pwd tsm10` <<EOF 

set pages 1000
set lin 270
set hea off
set feedback off

spool /export/home/oracle/log/PSW_Trials.csv

select '"Trial","Created By","Created On","Deleted By","Deleted On"' from dual;
select distinct '"'||b.protocol_identifier||'","'||c.name||'","'||
To_Char(a.create_date,'mm/dd/yyyy')||'","'||y.name||'","'||
To_Char(x.modify_date,'mm/dd/yyyy')||'"'
from trial_budget a, trial b, ftuser c, audit_hist x, ftuser y
where
a.trial_id=b.id and b.client_div_id=(select id from client_div where client_div_identifier='PSW')
and a.delete_flg=1
AND a.creator_ftuser_id=c.id AND
a.id=x.target_id and x.action = 'auditAction.budgetDeleted' AND
y.client_div_id=(select id from client_div where client_div_identifier='PSW') 
AND y.id=x.ftuser_id and x.target_primary_table='trial_budget';

select '"Project","Trial","Created By","Created On"' from dual;
SELECT '"'||d.name||'","'||a.protocol_identifier||'","'||
first_name||' '||last_name||'","'|| 
to_char(b.create_date,'mm/dd/yyyy')||'"'
FROM trial a, picase_trial b, ftuser c, project d
WHERE a.id=b.trial_id 
AND b.CREATOR_FTUSER_ID=c.id 
AND a.project_id=d.id
AND a.client_div_id=(select id from client_div where client_div_identifier='PSW')
ORDER BY create_date;	

spool off

spool /export/home/oracle/log/BGN_Trials.csv

select '"Trial","Created By","Created On","Deleted By","Deleted On"' from dual;
select distinct '"'||b.protocol_identifier||'","'||c.name||'","'||
To_Char(a.create_date,'mm/dd/yyyy')||'","'||y.name||'","'||
To_Char(x.modify_date,'mm/dd/yyyy')||'"'
from trial_budget a, trial b, ftuser c, audit_hist x, ftuser y
where
a.trial_id=b.id and b.client_div_id=(select id from client_div where client_div_identifier='BGN')
and a.delete_flg=1
AND a.creator_ftuser_id=c.id AND
a.id=x.target_id and x.action = 'auditAction.budgetDeleted' AND
y.client_div_id=(select id from client_div where client_div_identifier='BGN') 
AND y.id=x.ftuser_id and x.target_primary_table='trial_budget';

select '"Project","Trial","Created By","Created On"' from dual;
SELECT '"'||d.name||'","'||a.protocol_identifier||'","'||
first_name||' '||last_name||'","'|| 
to_char(b.create_date,'mm/dd/yyyy')||'"'
FROM trial a, picase_trial b, ftuser c, project d
WHERE a.id=b.trial_id 
AND b.CREATOR_FTUSER_ID=c.id 
AND a.project_id=d.id
AND a.client_div_id=(select id from client_div where client_div_identifier='BGN')
ORDER BY create_date;	

spool off

spool /export/home/oracle/log/VTX_Trials.csv

select '"Trial","Created By","Created On","Deleted By","Deleted On"' from dual;
select distinct '"'||b.protocol_identifier||'","'||c.name||'","'||
To_Char(a.create_date,'mm/dd/yyyy')||'","'||y.name||'","'||
To_Char(x.modify_date,'mm/dd/yyyy')||'"'
from trial_budget a, trial b, ftuser c, audit_hist x, ftuser y
where
a.trial_id=b.id and b.client_div_id=(select id from client_div where client_div_identifier='VTX')
and a.delete_flg=1
AND a.creator_ftuser_id=c.id AND
a.id=x.target_id and x.action = 'auditAction.budgetDeleted' AND
y.client_div_id=(select id from client_div where client_div_identifier='VTX') 
AND y.id=x.ftuser_id and x.target_primary_table='trial_budget';

select '"Project","Trial","Created By","Created On"' from dual;
SELECT '"'||d.name||'","'||a.protocol_identifier||'","'||
first_name||' '||last_name||'","'|| 
to_char(b.create_date,'mm/dd/yyyy')||'"'
FROM trial a, picase_trial b, ftuser c, project d
WHERE a.id=b.trial_id 
AND b.CREATOR_FTUSER_ID=c.id 
AND a.project_id=d.id
AND a.client_div_id=(select id from client_div where client_div_identifier='VTX')
ORDER BY create_date;	

spool off
exit;
EOF

mv /export/home/oracle/log/PSW_Trials.csv /export/home/oracle/log/PSW_Trials_$(date +%m%d%y).csv
mv /export/home/oracle/log/BGN_Trials.csv /export/home/oracle/log/BGN_Trials_$(date +%m%d%y).csv
mv /export/home/oracle/log/VTX_Trials.csv /export/home/oracle/log/VTX_Trials_$(date +%m%d%y).csv

sed "s/$/`echo \\\r`/" /export/home/oracle/log/PSW_Trials_$(date +%m%d%y).csv | \
uuencode PSW_Trials_$(date +%m%d%y).csv | \
mailx -r $sender -s "Trials Deleted and Created in PSW" -c $cclist $mailinglist

sed "s/$/`echo \\\r`/" /export/home/oracle/log/BGN_Trials_$(date +%m%d%y).csv | \
uuencode BGN_Trials_$(date +%m%d%y).csv | \
mailx -r $sender -s "Trials Deleted and Created in BGN" -c $cclist $mailinglist

sed "s/$/`echo \\\r`/" /export/home/oracle/log/VTX_Trials_$(date +%m%d%y).csv | \
uuencode VTX_Trials_$(date +%m%d%y).csv | \
mailx -r $sender -s "Trials Deleted and Created in VTX" -c $cclist $mailinglist



#############################################################
# MODIFICATION HISTORY:
#
# $Log: 
#  3    DevTSM    1.2         3/15/2005 6:16:42 PM Debashish Mishra  
#  2    DevTSM    1.1         3/3/2005 5:45:00 AM  Debashish Mishra  
#  1    DevTSM    1.0         2/28/2005 8:54:48 AM Debashish Mishra 
# $
# 
#############################################################
